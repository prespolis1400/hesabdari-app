<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F3F4F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali-js.min.js"></script>
    
    <style>
        :root {
            /* Light Theme */
            --primary: #00695C; --primary-light: #B2DFDB; --bg-app: #E0F2F1;
            --bg-card: rgba(255, 255, 255, 0.9); /* Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ */
            --text-main: #1F2937; --text-muted: #546E7A;
            --border: #CFD8DC; --accent: #F59E0B; --danger: #EF4444;
            --active-toggle: #00695C;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); --radius: 20px;
            --gradient-1: #E0F2F1; --gradient-2: #B2DFDB; --gradient-3: #FFFFFF;
        }

        [data-theme="dark"] {
            --primary: #80CBC4; --primary-light: #004D40; --bg-app: #102027;
            --bg-card: rgba(30, 41, 59, 0.9);
            --text-main: #ECEFF1; --text-muted: #B0BEC5; --border: #37474F;
            --active-toggle: #80CBC4;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --gradient-1: #0f172a; --gradient-2: #1e293b; --gradient-3: #000000;
        }

        [data-theme="year"] {
            /* Peach Fuzz Theme */
            --primary: #FF8A65; --primary-light: #FFCCBC; --bg-app: #FFF3E0;
            --bg-card: rgba(255, 255, 255, 0.9);
            --text-main: #4E342E; --text-muted: #8D6E63;
            --border: #FFAB91; --accent: #FF7043; --danger: #D32F2F;
            --active-toggle: #FF7043;
            --shadow: 0 8px 32px 0 rgba(255, 112, 67, 0.15);
            --gradient-1: #FFF3E0; --gradient-2: #FFCCBC; --gradient-3: #FFAB91;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        /* Animated Background */
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 0; height: 100dvh;
            display: flex; justify-content: center; overflow: hidden;
            color: var(--text-main);
            
            /* Ø¬Ø§Ø¯ÙˆÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† */
            background: linear-gradient(-45deg, var(--gradient-1), var(--gradient-2), var(--gradient-3), var(--gradient-1));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: color 0.4s;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .app-container {
            width: 100%; height: 100%; max-width: 450px;
            /* Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø´ÙØ§Ù Ø¨Ø§Ø´Ø¯ ØªØ§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø§Ø¯ÛŒ Ø¯ÛŒØ¯Ù‡ Ø´ÙˆØ¯ */
            background-color: transparent; 
            display: flex; flex-direction: column; position: relative;
            backdrop-filter: blur(5px); /* Ø§ÙÚ©Øª ØªØ§Ø± Ø´Ø¯Ù† Ù…Ù„Ø§ÛŒÙ… */
        }
        
        /* Header */
        .header { padding: 15px 20px; background: rgba(255,255,255,0.0); z-index: 10; transition: 0.3s; } /* Ù‡Ø¯Ø± Ú©Ø§Ù…Ù„Ø§ Ø´ÙØ§Ù */
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title { font-size: 20px; font-weight: 900; color: var(--primary); margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header-actions { display: flex; gap: 10px; }
        
        /* Glassmorphism Buttons */
        .icon-btn { 
            background: var(--bg-card); 
            color: var(--text-muted); border: 1px solid var(--border); 
            border-radius: 12px; width: 38px; height: 38px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; font-size: 18px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            backdrop-filter: blur(4px);
        }
        
        /* Tabs */
        .tab-container { 
            background: var(--bg-card); 
            border-radius: 16px; padding: 5px; display: flex; position: relative; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }
        .tab-btn { flex: 1; text-align: center; padding: 10px 0; font-size: 13px; font-weight: bold; color: var(--text-muted); cursor: pointer; z-index: 2; transition: color 0.3s; border-radius: 10px; }
        .tab-btn.active { color: var(--primary); }
        .tab-bg { position: absolute; top: 5px; bottom: 5px; right: 5px; width: calc(33.33% - 6px); background: var(--primary-light); border-radius: 12px; opacity: 0.4; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; }

        /* Content */
        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 180px; scroll-behavior: smooth; }
        .main-content::-webkit-scrollbar { width: 0; }
        .page { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards - Glassmorphism Style */
        .card { 
            background: var(--bg-card); 
            border-radius: var(--radius); padding: 22px; margin-bottom: 18px; 
            box-shadow: var(--shadow); border: 1px solid var(--border); 
            transition: 0.3s; backdrop-filter: blur(12px);
        }
        
        .input-group { flex: 1; display: flex; flex-direction: column; }
        .input-group label { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: bold; color: var(--text-muted); margin-bottom: 8px; min-height: 24px; }
        .input-row { display: flex; gap: 12px; margin-bottom: 15px; }
        
        input, select { 
            width: 100%; padding: 12px; 
            background: rgba(255,255,255,0.5); /* Ù†ÛŒÙ…Ù‡ Ø´ÙØ§Ù */
            border: 1px solid var(--border); border-radius: 14px; 
            font-family: 'Vazirmatn'; font-size: 17px; color: var(--text-main); 
            text-align: center; height: 50px; transition: 0.2s; font-weight: bold; 
        }
        [data-theme="dark"] input, [data-theme="dark"] select { background: rgba(0,0,0,0.2); }
        
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); transform: translateY(-1px); }

        /* Buttons */
        .btn { width: 100%; padding: 15px; border-radius: 14px; border: none; font-family: 'Vazirmatn'; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--active-toggle)); 
            color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
        }
        .btn-primary:active { transform: scale(0.97); }
        .btn-ghost { background: transparent; color: var(--text-muted); font-size: 12px; padding: 8px; margin-top: 5px; width: auto; border-radius: 8px; border: 1px dashed var(--border); }
        .btn-add { background: var(--accent); color: white; margin-top: 0; height: 50px; width: 50px; border-radius: 14px; font-size: 26px; padding: 0; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-transfer { background: rgba(255,255,255,0.5); color: var(--primary); border: 2px solid var(--primary); border-radius: 12px; padding: 10px 15px; font-size: 13px; font-weight: bold; margin-top: 15px; cursor: pointer; width: 100%; transition:0.2s; }
        
        /* Switches & Rate Badge */
        .rate-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: var(--primary-light); border: 1px solid var(--border);
            padding: 3px 8px; border-radius: 8px; cursor: pointer;
            transition: 0.3s;
        }
        .rate-badge.active { background: var(--active-toggle); border-color: var(--active-toggle); color: white; }
        .rate-text { font-size: 10px; font-weight: bold; }
        .rate-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); transition: 0.3s; }
        .rate-badge.active .rate-dot { background: white; box-shadow: 0 0 4px rgba(255,255,255,0.8); }

        .toggle-switch { position: relative; width: 36px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--active-toggle); }
        html[dir="rtl"] input:checked + .slider:before { transform: translateX(16px); }

        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
        .chip { background: rgba(255,255,255,0.5); padding: 10px 0; border-radius: 12px; font-size: 13px; text-align: center; color: var(--text-muted); cursor: pointer; border: 1px solid var(--border); transition: 0.2s; font-weight: 600; }
        .chip.selected { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.15); transform: translateY(-2px); }

        .mode-switch { display: flex; background: rgba(255,255,255,0.5); padding: 4px; border-radius: 14px; margin-bottom: 15px; border: 1px solid var(--border); }
        .mode-btn { flex: 1; padding: 8px; text-align: center; font-size: 12px; cursor: pointer; border-radius: 10px; color: var(--text-muted); transition: 0.3s; font-weight: bold; }
        .mode-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }

        .result-panel { background: linear-gradient(135deg, var(--primary), var(--active-toggle)); color: white; text-align: center; display: none; margin-top: 15px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.25); position: relative; overflow: hidden; }
        .result-panel::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0) 60%); pointer-events: none; }
        .res-val { font-size: 26px; font-weight: 900; margin: 8px 0; letter-spacing: -1px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .res-lbl { font-size: 12px; opacity: 0.95; position: relative; }
        .res-sub { border-top: 1px dashed rgba(255,255,255,0.3); margin-top: 12px; padding-top: 12px; font-size: 13px; position: relative; }

        .cheque-list { margin-top: 10px; }
        .cheque-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); animation: slideIn 0.2s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(5px); } to { opacity: 1; transform: translateX(0); } }
        .c-date { font-weight: bold; font-size: 14px; color: var(--text-main); }
        .c-amt { color: var(--primary); font-weight: 800; font-size: 14px; }
        .btn-del { color: var(--danger); font-size: 20px; cursor: pointer; padding: 2px 8px; background: rgba(239, 68, 68, 0.08); border-radius: 6px; }
        .empty-list { text-align: center; padding: 25px; color: var(--text-muted); font-size: 13px; opacity: 0.6; }

        .fixed-footer { position: absolute; bottom: 0; left: 0; right: 0; background: var(--bg-card); padding: 15px 20px 25px 20px; border-radius: 24px 24px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.06); z-index: 100; display: none; border-top: 1px solid var(--border); backdrop-filter: blur(15px); }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; }
        .stat-item span { display: block; }
        .stat-val { font-weight: 900; font-size: 14px; color: var(--text-main); }
        .stat-lbl { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
        .final-box { background: rgba(255,255,255,0.3); border-radius: 14px; padding: 10px 15px; margin-top: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .final-val { font-size: 17px; font-weight: 900; color: var(--accent); }

        .date-select-group { display: flex; gap: 5px; direction: ltr; }
        .date-select-group select { padding: 8px 2px; font-size: 13px; direction: rtl; }
        
        .ch-mode-panel { display: none; } .ch-mode-panel.active { display: block; animation: fadeIn 0.2s; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-box { background: var(--bg-card); padding: 25px; border-radius: 24px; width: 85%; max-width: 320px; text-align: center; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow); }
        .modal-close { position: absolute; top: 15px; left: 15px; font-size: 24px; cursor: pointer; color: var(--text-muted); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); border-radius: 50%; }
        .help-item { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; text-align: right; }
        .help-title { font-weight: 900; color: var(--primary); margin-bottom: 6px; display: block; font-size: 14px; }
        .help-desc { font-size: 13px; color: var(--text-muted); line-height: 1.7; text-align: justify; }
        .signature { text-align: center; font-size: 10px; opacity: 0.4; margin-top: 25px; margin-bottom: 5px; color: var(--text-main); }

    </style>
</head>
<body>

<div class="app-container" id="appContainer">
    
    <div class="header">
        <div class="header-top">
            <div class="header-actions">
                <div class="icon-btn" onclick="toggleHelp()">?</div>
                <div class="icon-btn" onclick="toggleTheme()" id="themeIcon">ğŸŒ™</div>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <div class="vip-badge" id="vipBadge">VIP</div>
                <h1 class="header-title">Ø¬Ø¹Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø± Ù…Ø§Ù„ÛŒ</h1>
            </div>
        </div>

        <div class="tab-container" id="tabContainer">
            <div class="tab-btn active" onclick="setTab(0)">Ø§Ù‚Ø³Ø§Ø· ÙˆØ§Ù…</div>
            <div class="tab-btn" onclick="setTab(1)">Ù…Ø¹Ú©ÙˆØ³</div>
            <div class="tab-btn" onclick="setTab(2)">Ø±Ø£Ø³â€ŒÚ¯ÛŒØ± Ú†Ú©</div>
            <div class="tab-bg" id="tabIndicator"></div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        
        <div class="page active" id="page0">
            <div class="card">
                <div class="input-group">
                    <label>Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="tel" id="loanAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ ÛµÛ°,Û°Û°Û°,Û°Û°Û°" oninput="fmt(this); calcLoan()">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>
                            Ø³ÙˆØ¯ %
                            <div class="rate-badge" id="loanRateBadge" onclick="toggleRate('loan')">
                                <span class="rate-dot"></span>
                                <span class="rate-text">Û´.ÛµÙª</span>
                            </div>
                        </label>
                        <input type="tel" id="loanRate" value="Û³.Û¹" oninput="fmtFa(this); calcLoan()">
                    </div>
                    <div class="input-group">
                        <label>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</label>
                        <input type="tel" id="loanMonths" value="Û´" oninput="fmtFa(this); calcLoan()">
                    </div>
                </div>

                <div class="chips">
                    <div class="chip selected" onclick="setMLoan(4, this)">Û´ Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setMLoan(8, this)">Û¸ Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setMLoan(12, this)">Û±Û² Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setMLoan(16, this)">Û±Û¶ Ù…Ø§Ù‡</div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                    <label style="margin:0; font-size:13px; font-weight:bold; color:var(--text-main);">ÛŒÚ© Ù…Ø§Ù‡ Ø³ÙˆØ¯ Ø§Ø¶Ø§ÙÙ‡ (+Û±)</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="loanExtra" onchange="calcLoan()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card result-panel" id="loanResult">
                <div class="res-lbl" id="loanTotal"></div>
                <div class="res-val" id="loanMonthly"></div>
                <div class="res-sub" id="loanInterest"></div>
                <div style="font-size:10px; margin-top:5px; opacity:0.7;">(Ø±ÙÙ†Ø¯ Ø´Ø¯Ù‡ Ø¨Ù‡ ÛµÛ°Û°Û° ØªÙˆÙ…Ø§Ù† Ø¨Ø§Ù„Ø§)</div>
                <button class="btn-transfer" id="btnTransfer" onclick="transferToCheque()">ØªÙˆÙ„ÛŒØ¯ Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† ÙˆØ§Ù… â¬…ï¸</button>
            </div>
            
            <button class="btn btn-primary" onclick="calcLoan()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
            <button class="btn btn-ghost" onclick="resetLoan()">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ±Ù…</button>
        </div>

        <div class="page" id="page1">
            <div class="card">
                <div class="input-group">
                    <label>ØªÙˆØ§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø· (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="tel" id="revAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ûµ,Û°Û°Û°,Û°Û°Û°" oninput="fmt(this); calcRev()">
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>
                            Ø³ÙˆØ¯ %
                            <div class="rate-badge" id="revRateBadge" onclick="toggleRate('rev')">
                                <span class="rate-dot"></span>
                                <span class="rate-text">Û´.ÛµÙª</span>
                            </div>
                        </label>
                        <input type="tel" id="revRate" value="Û³.Û¹" oninput="fmtFa(this); calcRev()">
                    </div>
                    <div class="input-group">
                        <label>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</label>
                        <input type="tel" id="revMonths" value="Û´" oninput="fmtFa(this); calcRev()">
                    </div>
                </div>

                <div class="chips">
                    <div class="chip selected" onclick="setMRev(4, this)">Û´ Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setMRev(8, this)">Û¸ Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setMRev(12, this)">Û±Û² Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setMRev(16, this)">Û±Û¶ Ù…Ø§Ù‡</div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                    <label style="margin:0; font-size:13px; font-weight:bold; color:var(--text-main);">Ø³ÙˆØ¯ Ø§Ø¶Ø§ÙÙ‡ (+Û±)</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="revExtra" onchange="calcRev()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card result-panel" id="revResult">
                <div class="res-lbl">Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ Ú©Ø§Ù„Ø§:</div>
                <div class="res-val" id="revPrincipal"></div>
                <div class="res-sub" id="revTotal"></div>
            </div>
            <button class="btn btn-primary" onclick="calcRev()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
        </div>

        <div class="page" id="page2">
            
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:end;">
                <div style="width: 70px;">
                    <label style="font-size:11px; color:var(--text-muted); font-weight:bold; margin-bottom:5px; display:block">Ø¯Ø±ØµØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡</label>
                    <input type="tel" id="chRate" value="Ûµ" oninput="fmtFa(this); calcCh()" style="padding:8px; height:40px; font-size:15px;">
                </div>
                
                <div style="flex:1; margin:0 12px;">
                    <label style="font-size:11px; color:var(--text-muted); text-align:center; display:block; font-weight:bold; margin-bottom:5px">ØªØ§Ø±ÛŒØ® Ù…Ø¨Ù†Ø§ (Ø§Ù…Ø±ÙˆØ²)</label>
                    <div class="date-select-group" style="justify-content:center;">
                        <select id="baseY" onchange="updBase()"></select>
                        <select id="baseM" onchange="updBase()"></select>
                        <select id="baseD" onchange="updBase()"></select>
                    </div>
                </div>
                
                <button class="btn-ghost" onclick="resetCh()" style="color:var(--danger); border:1px solid var(--danger); padding:8px 12px; height:40px; margin-top:20px;">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
            </div>

            <div class="mode-switch">
                <div class="mode-btn active" onclick="setChMode('single')" id="btnModeSingle">ÙˆØ±ÙˆØ¯ ØªÚ©ÛŒ</div>
                <div class="mode-btn" onclick="setChMode('batch')" id="btnModeBatch">ØªÙˆÙ„ÛŒØ¯ Ú¯Ø±ÙˆÙ‡ÛŒ</div>
                <div class="mode-btn" onclick="setChMode('smart')" id="btnModeSmart">Ù…Ø¹Ú©ÙˆØ³ Ú†Ú©</div>
            </div>

            <div class="card">
                <div id="panelSingle" class="ch-mode-panel active">
                    <div class="input-row">
                        <div class="input-group">
                            <label>Ù…Ø¨Ù„Øº Ú†Ú©</label>
                            <input type="tel" id="chAmtS" placeholder="ØªÙˆÙ…Ø§Ù†" oninput="fmt(this)">
                        </div>
                        <div class="input-group" style="width: 55px; flex:none;">
                            <label>&nbsp;</label>
                            <button class="btn-add" onclick="addSingle()">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ØªØ§Ø±ÛŒØ® Ú†Ú©</label>
                        <div class="date-select-group">
                            <select id="chYS"></select>
                            <select id="chMS"></select>
                            <select id="chDS"></select>
                        </div>
                    </div>
                </div>

                <div id="panelBatch" class="ch-mode-panel">
                    <div class="input-row">
                        <div class="input-group" style="flex:2">
                            <label>Ù…Ø¨Ù„Øº Ù‡Ø± Ú†Ú©</label>
                            <input type="tel" id="chAmtB" placeholder="ØªÙˆÙ…Ø§Ù†" oninput="fmt(this)">
                        </div>
                        <div class="input-group" style="flex:1">
                            <label>ØªØ¹Ø¯Ø§Ø¯</label>
                            <input type="tel" id="chCntB" placeholder="Ø¹Ø¯Ø¯" oninput="fmtFa(this)">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group" style="flex:1">
                            <label>ÙØ§ØµÙ„Ù‡ (Ù…Ø§Ù‡)</label>
                            <select id="chStepB" style="padding:0 5px;" onchange="updDefDateBatch()">
                                <option value="1">Û± Ù…Ø§Ù‡Ù‡</option><option value="2">Û² Ù…Ø§Ù‡Ù‡</option>
                                <option value="3">Û³ Ù…Ø§Ù‡Ù‡</option><option value="4">Û´ Ù…Ø§Ù‡Ù‡</option>
                            </select>
                        </div>
                        <div class="input-group" style="flex:2">
                            <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
                            <div class="date-select-group">
                                <select id="chYB"></select>
                                <select id="chMB"></select>
                                <select id="chDB"></select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addBatch()">ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒØ³Øª</button>
                </div>

                <div id="panelSmart" class="ch-mode-panel">
                    <div class="input-row">
                        <div class="input-group" style="flex:2">
                            <label>Ù…Ø¨Ù„Øº Ø®Ø§Ù„Øµ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²</label>
                            <input type="tel" id="chNetSmart" placeholder="ØªÙˆÙ…Ø§Ù†" oninput="fmt(this)">
                        </div>
                        <div class="input-group" style="flex:1">
                            <label>ØªØ¹Ø¯Ø§Ø¯ Ú†Ú©</label>
                            <input type="tel" id="chCntSmart" placeholder="Ø¹Ø¯Ø¯" oninput="fmtFa(this)">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group" style="flex:1">
                            <label>ÙØ§ØµÙ„Ù‡</label>
                            <select id="chStepSmart" style="padding:0 5px;" onchange="updateSmartDate()">
                                <option value="1">Û± Ù…Ø§Ù‡Ù‡</option>
                                <option value="45">Û´Ûµ Ø±ÙˆØ²Ù‡</option>
                                <option value="2">Û² Ù…Ø§Ù‡Ù‡</option>
                                <option value="3">Û³ Ù…Ø§Ù‡Ù‡</option>
                                <option value="4">Û´ Ù…Ø§Ù‡Ù‡</option>
                                <option value="6">Û¶ Ù…Ø§Ù‡Ù‡</option>
                            </select>
                        </div>
                        <div class="input-group" style="flex:2">
                            <label>ØªØ§Ø±ÛŒØ® Ø§ÙˆÙ„ÛŒÙ† Ú†Ú©</label>
                            <div class="date-select-group">
                                <select id="chYSmart"></select>
                                <select id="chMSmart"></select>
                                <select id="chDSmart"></select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="calcSmartRas()">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ ØªÙˆÙ„ÛŒØ¯</button>
                </div>
            </div>

            <div class="card" style="padding: 15px; min-height: 100px;">
                <div style="font-size:12px; font-weight:bold; color:var(--text-muted); margin-bottom:10px;">Ù„ÛŒØ³Øª Ú†Ú©â€ŒÙ‡Ø§</div>
                <div class="cheque-list" id="chList">
                    <div class="empty-list">Ù‡Ù†ÙˆØ² Ú†Ú©ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed-footer" id="chFooter">
        <div class="grid-4">
            <div class="stat-item"><span class="stat-val" id="fCnt">Û°</span><span class="stat-lbl">ØªØ¹Ø¯Ø§Ø¯</span></div>
            <div class="stat-item"><span class="stat-val" id="fDays">Û°</span><span class="stat-lbl">Ø±ÙˆØ² Ø±Ø£Ø³</span></div>
            <div class="stat-item"><span class="stat-val" id="fInt">Û°</span><span class="stat-lbl">Ú©Ø§Ø±Ù…Ø²Ø¯</span></div>
            <div class="stat-item"><span class="stat-val" id="fTot">Û°</span><span class="stat-lbl">Ú©Ù„</span></div>
        </div>
        <div class="final-box">
            <span style="font-size:13px;">Ø®Ø§Ù„Øµ Ø¯Ø±ÛŒØ§ÙØªÛŒ:</span>
            <span class="final-val" id="fNet">Û°</span>
        </div>
        <div style="text-align:center; font-size:11px; margin-top:5px; color:var(--text-muted);">
            ØªØ§Ø±ÛŒØ® Ø±Ø£Ø³: <span id="fDate" style="font-weight:bold;">---</span>
        </div>
    </div>

    <div id="vipModal" class="modal" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-box">
            <span class="vip-icon">ğŸ‘‘</span>
            <h3 style="margin:0; margin-bottom:10px;">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ VIP</h3>
            <p style="font-size:13px; color:var(--text-muted);">Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ØŒ Ø´Ù†Ø§Ø³Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:</p>
            <div class="vip-id-box" id="deviceIdBox">---</div>
            <p style="font-size:11px; margin-bottom:15px; color:var(--text-muted);">Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®ØªØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.</p>
            <button class="btn-vip" onclick="location.reload()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª</button>
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="if(event.target===this)toggleHelp()">
        <div class="modal-box">
            <div class="modal-close" onclick="toggleHelp()">Ã—</div>
            <h3>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡</h3>
            <div class="help-item">
                <span class="help-title">Û±. Ø§Ù‚Ø³Ø§Ø· ÙˆØ§Ù…</span>
                <span class="help-desc">
                    Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚Ø³Ø·ØŒ Ø³ÙˆØ¯ Ùˆ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª.
                    <br><b>Ú¯Ø²ÛŒÙ†Ù‡ Û´.ÛµÙª:</b> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø±ÛŒØ¹ Ø¨Ø§ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ø§Ø²Ø§Ø±.
                    <br><b>Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ú†Ú©:</b> Ù…Ø¨Ù„Øº Ú†Ú©â€ŒÙ‡Ø§ Ø·ÙˆØ±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ Ø®Ø§Ù„Øµ Ø¯Ø±ÛŒØ§ÙØªÛŒ (Ø¨Ø§ Ú©Ø³Ø± Ø³ÙˆØ¯ Ú†Ú©) Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø± Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ø´ÙˆØ¯.
                </span>
            </div>
            <div class="help-item"><span class="help-title">Û². Ù…Ø¹Ú©ÙˆØ³</span>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ Ú©Ø§Ù„Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙˆØ§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø· Ù…Ø´ØªØ±ÛŒ.</div>
            <div class="help-item">
                <span class="help-title">Û³. Ø±Ø£Ø³â€ŒÚ¯ÛŒØ± Ú†Ú©</span>
                <span class="help-desc">
                    Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø±Ø£Ø³ Ùˆ Ø³ÙˆØ¯ Ú†Ú©â€ŒÙ‡Ø§.
                    <br><b>ÙˆØ±ÙˆØ¯ ØªÚ©ÛŒ:</b> Ø¨Ø±Ø§ÛŒ Ú†Ú©â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…Ù†Ø¸Ù….
                    <br><b>Ù…Ø¹Ú©ÙˆØ³ Ú†Ú©:</b> Ù…Ø¨Ù„Øº Ø®Ø§Ù„ØµÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø¨Ù„Øº Ú†Ú©â€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø³Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                </span>
            </div>
            <div class="signature">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³: Ø­ÛŒØ¯Ø± Ø­ÛŒØ¯Ø±ÛŒ</div>
        </div>
    </div>

</div>

<script>
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª (Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯)
    const SCRIPT_URL = "URL_GOOGLE_SCRIPT_SHOMA"; 

    const _ = id => document.getElementById(id);
    const toFa = n => (n===undefined||n===null)?'':n.toString().replace(/\d/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);
    const toEn = s => s ? s.toString().replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)).replace(/,/g,'') : '';
    const sep = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    function fmt(el) { let v = toEn(el.value).replace(/[^0-9]/g,''); el.value = v ? toFa(parseInt(v).toLocaleString()) : ''; }
    function fmtFa(el) { let v = toEn(el.value); el.value = v ? toFa(v) : ''; }

    // --- VIP & Security ---
    let deviceId = localStorage.getItem('did') || 'U' + Math.floor(Math.random() * 9000000);
    localStorage.setItem('did', deviceId);
    let userStatus = { status: "Free", loan: 0, ras: 0 };
    const LIMITS = { loan: 5, ras: 1 };

    window.addEventListener('load', () => { initDate(); setupSwipe(); });

    // --- Logic ---
    function toggleRate(type) {
        const input = _(type + 'Rate');
        const badge = _(type + 'RateBadge');
        const is45 = input.value == toFa(4.5);
        
        if (is45) {
            input.value = toFa(3.9);
            badge.classList.remove('active');
        } else {
            input.value = toFa(4.5);
            badge.classList.add('active');
        }
        
        if(type==='loan') calcLoan(); else calcRev();
    }

    let currentTab = 0;
    function setTab(idx) {
        currentTab = idx;
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        document.querySelectorAll('.page').forEach((p, i) => p.classList.toggle('active', i === idx));
        _('tabIndicator').style.transform = `translateX(${idx * -100}%)`;
        const footer = _('chFooter');
        footer.style.display = (idx === 2) ? 'block' : 'none';
    }

    // Swipe Feature
    function setupSwipe() {
        let startX = 0;
        const content = _('mainContent');
        content.addEventListener('touchstart', e => startX = e.changedTouches[0].screenX);
        content.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].screenX;
            if (endX < startX - 50 && currentTab < 2) setTab(currentTab + 1); // Swipe Left -> Next
            if (endX > startX + 50 && currentTab > 0) setTab(currentTab - 1); // Swipe Right -> Prev
        });
    }

    let themeIndex = 0;
    const themes = ['', 'dark', 'year'];
    const themeIcons = ['ğŸŒ™', 'â˜€ï¸', 'ğŸ‘'];
    function toggleTheme() {
        themeIndex = (themeIndex + 1) % themes.length;
        const newTheme = themes[themeIndex];
        const html = document.documentElement;
        
        if(newTheme) html.setAttribute('data-theme', newTheme);
        else html.removeAttribute('data-theme');
        
        _('themeIcon').innerText = themeIcons[themeIndex];
        
        let color = '#F3F4F6';
        if(newTheme === 'dark') color = '#111827';
        if(newTheme === 'year') color = '#FFF3E0';
        document.querySelector('meta[name="theme-color"]').setAttribute('content', color);
    }

    function toggleHelp() {
        const m = _('helpModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    // LOAN
    let lastCalculatedMonthly = 0;
    let lastPrincipal = 0;
    function setMLoan(m, el) { _('loanMonths').value = toFa(m); _('page0').querySelectorAll('.chip').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); calcLoan(); }
    function calcLoan() {
        let p = parseFloat(toEn(_('loanAmount').value)), m = parseInt(toEn(_('loanMonths').value)), r = parseFloat(toEn(_('loanRate').value));
        if(!p || !m) { _('loanResult').style.display='none'; return; }
        let extra = _('loanExtra').checked ? 1 : 0;
        let interest = p * (r/100) * (m + extra);
        let total = p + interest;
        let monthly = Math.ceil((total / m) / 5000) * 5000;
        let finalTotal = monthly * m;
        let finalInt = finalTotal - p;
        lastCalculatedMonthly = monthly;
        lastPrincipal = p;
        _('loanTotal').innerText = `Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù„: ${toFa(sep(finalTotal))} ØªÙˆÙ…Ø§Ù†`;
        _('loanMonthly').innerText = `${toFa(sep(monthly))} ØªÙˆÙ…Ø§Ù†`;
        _('loanInterest').innerText = `Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ: ${toFa(sep(finalInt))} ØªÙˆÙ…Ø§Ù†`;
        _('loanResult').style.display='block';
    }
    function resetLoan() { _('loanAmount').value=''; _('loanResult').style.display='none'; _('loanRate').value=toFa(3.9); _('loanRateBadge').classList.remove('active'); }

    function transferToCheque() {
        let principal = lastPrincipal || parseFloat(toEn(_('loanAmount').value));
        let cnt = parseInt(toEn(_('loanMonths').value));
        let targetRate = parseFloat(toEn(_('chRate').value)) || 5; 

        if (!principal || !cnt) return alert("Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†ÛŒØ¯");

        setTab(2);
        setChMode('batch');
        
        let step = 1; 
        _('chStepB').value = step;
        
        // Reverse Engineering Logic
        let avgMonths = ((cnt + 1) / 2) * step;
        let factor = 1 - ((targetRate / 100) * (avgMonths)); 
        
        if (factor <= 0) return alert("Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ø³ÛŒØ§Ø± Ø²ÛŒØ§Ø¯ Ø§Ø³Øª");

        let requiredTotal = principal / factor;
        let singleCheck = Math.ceil((requiredTotal / cnt) / 5000) * 5000;

        _('chAmtB').value = toFa(sep(singleCheck));
        _('chCntB').value = toFa(cnt);
        updDefDateBatch();
    }

    // REVERSE
    function setMRev(m, el) { _('revMonths').value = toFa(m); _('page1').querySelectorAll('.chip').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); calcRev(); }
    function calcRev() {
        let mont = parseFloat(toEn(_('revAmount').value)), m = parseInt(toEn(_('revMonths').value)), r = parseFloat(toEn(_('revRate').value));
        if(!mont || !m) { _('revResult').style.display='none'; return; }
        let extra = _('revExtra').checked ? 1 : 0;
        let factor = 1 + ((r/100) * (m + extra));
        let principal = Math.round((mont * m) / factor);
        _('revPrincipal').innerText = `${toFa(sep(principal))} ØªÙˆÙ…Ø§Ù†`;
        _('revTotal').innerText = `Ø¬Ù…Ø¹ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª: ${toFa(sep(mont*m))}`;
        _('revResult').style.display='block';
    }

    // CHEQUE
    let cheques=[], baseDate={};
    function initDate() {
        const fill = (ids, start, end) => { ids.forEach(id => { let h=''; for(let i=start; i<=end; i++) h+=`<option value="${i}">${toFa(i)}</option>`; _(id).innerHTML=h; }); };
        fill(['baseD','chDS','chDB','chDSmart'],1,31); 
        fill(['baseM','chMS','chMB','chMSmart'],1,12); 
        fill(['baseY','chYS','chYB','chYSmart'],1402,1410);
        
        const j = gregorianToJalali(new Date());
        baseDate = {y:j[0], m:j[1], d:j[2]};
        _('baseY').value=j[0]; _('baseM').value=j[1]; _('baseD').value=j[2];
        
        updDefDateBatch();
        updateSmartDate();
        _('chYS').value=j[0]; _('chMS').value=j[1]; _('chDS').value=j[2];
    }
    
    function updBase() { baseDate = {y:parseInt(_('baseY').value), m:parseInt(_('baseM').value), d:parseInt(_('baseD').value)}; calcCh(); }
    
    function updDefDateBatch() {
        let step = parseInt(_('chStepB').value);
        let by = parseInt(_('baseY').value), bm = parseInt(_('baseM').value), bd = parseInt(_('baseD').value);
        let g = jalaliToGregorian(by, bm, bd);
        let d = new Date(g.y, g.m-1, g.d); d.setMonth(d.getMonth()+step);
        let j = gregorianToJalali(d);
        _('chYB').value=j[0]; _('chMB').value=j[1]; _('chDB').value=j[2];
    }

    function updateSmartDate() {
        let step = parseInt(_('chStepSmart').value);
        if(step === 45) step = 1; 
        let by = parseInt(_('baseY').value), bm = parseInt(_('baseM').value), bd = parseInt(_('baseD').value);
        let g = jalaliToGregorian(by, bm, bd);
        let d = new Date(g.y, g.m-1, g.d); 
        
        if(_('chStepSmart').value === "45") d.setDate(d.getDate() + 45);
        else d.setMonth(d.getMonth() + step);
        
        let j = gregorianToJalali(d);
        _('chYSmart').value=j[0]; _('chMSmart').value=j[1]; _('chDSmart').value=j[2];
    }

    function setChMode(m) {
        _('btnModeSingle').classList.remove('active'); _('btnModeBatch').classList.remove('active'); _('btnModeSmart').classList.remove('active');
        _('panelSingle').classList.remove('active'); _('panelBatch').classList.remove('active'); _('panelSmart').classList.remove('active');
        
        if(m==='single') { _('btnModeSingle').classList.add('active'); _('panelSingle').classList.add('active'); }
        else if(m==='batch') { _('btnModeBatch').classList.add('active'); _('panelBatch').classList.add('active'); }
        else { _('btnModeSmart').classList.add('active'); _('panelSmart').classList.add('active'); }
    }

    function addSingle() {
        let amt = parseInt(toEn(_('chAmtS').value)); if(!amt) return;
        cheques.push({ y:parseInt(_('chYS').value), m:parseInt(_('chMS').value), d:parseInt(_('chDS').value), amt:amt });
        recalcBalances(); renderCh(); _('chAmtS').value='';
    }

    function addBatch() {
        let amt = parseInt(toEn(_('chAmtB').value)), cnt = parseInt(toEn(_('chCntB').value)); if(!amt||!cnt) return;
        let step = parseInt(_('chStepB').value);
        let sy=parseInt(_('chYB').value), sm=parseInt(_('chMB').value), sd=parseInt(_('chDB').value);
        for(let i=0; i<cnt; i++) {
            let addM = i * step; let tm = sm + addM;
            let ny = sy + Math.floor((tm-1)/12); let nm = ((tm-1)%12) + 1;
            let nd = sd; if(nm>6 && nd==31) nd=30; if(nm==12 && nd>29) nd=29;
            cheques.push({ y:ny, m:nm, d:nd, amt:amt });
        }
        recalcBalances(); renderCh();
    }

    function calcSmartRas() {
        let net = parseInt(toEn(_('chNetSmart').value));
        let cnt = parseInt(toEn(_('chCntSmart').value));
        if(!net || !cnt) return;
        
        let intervalVal = _('chStepSmart').value;
        let loopInterval = (intervalVal === '45') ? 2 : parseInt(intervalVal);
        let rate = parseFloat(toEn(_('chRate').value)) || 0;

        let sY = parseInt(_('chYSmart').value), sM = parseInt(_('chMSmart').value), sD = parseInt(_('chDSmart').value);
        let bY = parseInt(_('baseY').value), bM = parseInt(_('baseM').value), bD = parseInt(_('baseD').value);
        
        let baseG = jalaliToGregorian(bY, bM, bD);
        let baseDateObj = new Date(baseG.y, baseG.m - 1, baseG.d);

        let totalFactor = 0;
        let tempCheques = [];
        let curY = sY, curM = sM;

        for(let i=0; i<cnt; i++) {
            let day = sD;
            if(sD > 30 && curM > 6) day = 30;
            if(curM === 12 && day > 29) day = 29;

            let checkG = jalaliToGregorian(curY, curM, day);
            let checkDate = new Date(checkG.y, checkG.m - 1, checkG.d);
            
            let diff = Math.ceil((checkDate - baseDateObj) / (1000*60*60*24));
            if(diff <= 0) diff = 0;

            let interest = (rate/100) * (diff/30);
            let factor = 1 - interest;
            
            if(factor <= 0) return alert("Ø³ÙˆØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ø¨Ù„Øº Ú†Ú© Ø´Ø¯Ù‡ Ø§Ø³Øª!");
            
            totalFactor += factor;
            
            tempCheques.push({ y:curY, m:curM, d:day });

            if (intervalVal === '45') {
               checkDate.setDate(checkDate.getDate() + 45);
               let nextJ = gregorianToJalali(checkDate);
               curY = nextJ[0]; curM = nextJ[1]; day = nextJ[2]; 
               sD = day; 
            } else {
                curM += loopInterval;
                while(curM > 12) { curM -= 12; curY++; }
            }
        }

        let checkVal = net / totalFactor;
        checkVal = Math.ceil(checkVal / 5000) * 5000;

        cheques = [];
        tempCheques.forEach(c => {
            cheques.push({ y:c.y, m:c.m, d:c.d, amt:checkVal });
        });
        recalcBalances(); renderCh();
    }

    function recalcBalances() { let total = cheques.reduce((acc,c)=>acc+c.amt,0); let running=total; cheques.forEach(c=>{c.bal=running-c.amt; running-=c.amt;}); }
    
    function renderCh() {
        const list = _('chList');
        if(cheques.length === 0) {
            list.innerHTML = '<div class="empty-list">Ù‡Ù†ÙˆØ² Ú†Ú©ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
            _('fCnt').innerText = "Û°"; _('fDays').innerText = "Û°"; _('fTot').innerText = "Û°";
            _('fInt').innerText = "Û°"; _('fNet').innerText = "Û°"; _('fDate').innerText = "---";
            return;
        }
        
        let h='', tot=0, wSum=0;
        cheques.forEach((c,i)=>{
            let days = diffDays(baseDate, {y:c.y, m:c.m, d:c.d});
            tot+=c.amt; wSum+=c.amt*days;
            h+=`<div class="cheque-row"><div style="flex:1"><div class="c-date">${toFa(c.y)}/${toFa(c.m)}/${toFa(c.d)} <span style="font-weight:normal; font-size:11px; color:#666">(${toFa(days)} Ø±ÙˆØ²)</span></div><div class="c-sub">Ù…Ø§Ù†Ø¯Ù‡: ${toFa(sep(c.bal))}</div></div><div style="text-align:left"><div class="c-amt">${toFa(sep(c.amt))}</div><span class="btn-del" onclick="delCh(${i})">Ã—</span></div></div>`;
        });
        list.innerHTML=h;
        
        let ras = tot>0 ? wSum/tot : 0;
        let r = parseFloat(toEn(_('chRate').value))||0;
        let interest = tot * (r/100) * (ras/30);
        let rdStr = "---";
        
        if(tot > 0){
            let g = jalaliToGregorian(baseDate.y, baseDate.m, baseDate.d);
            let t = new Date(g.y, g.m-1, g.d); t.setDate(t.getDate() + Math.round(ras));
            let j = gregorianToJalali(t);
            rdStr = `${toFa(j[0])}/${toFa(j[1])}/${toFa(j[2])}`;
        }
        
        _('fCnt').innerText=toFa(cheques.length); 
        _('fDays').innerText=toFa(Math.round(ras)); 
        _('fTot').innerText=toFa(sep(tot));
        _('fInt').innerText=toFa(sep(Math.round(interest))); 
        _('fNet').innerText=toFa(sep(Math.round(tot-interest))); 
        _('fDate').innerText=rdStr;
    }

    function delCh(i) { cheques.splice(i,1); recalcBalances(); renderCh(); }
    
    function resetCh() { 
        cheques=[]; 
        _('chAmtB').value=''; _('chCntB').value=''; _('chAmtS').value=''; 
        _('chNetSmart').value=''; _('chCntSmart').value='';
        renderCh(); 
    }
    
    function calcCh(){ renderCh(); } 

    function jalaliToGregorian(j_y, j_m, j_d) { j_y=parseInt(j_y); j_m=parseInt(j_m); j_d=parseInt(j_d); var jy=j_y-979; var jm=j_m-1; var jd=j_d-1; var j_day_no=365*jy+parseInt(jy/33)*8+parseInt((jy%33+3)/4); for(var i=0;i<jm;++i)j_day_no+=(i<6)?31:30; j_day_no+=jd; var g_day_no=j_day_no+79; var gy=1600+400*parseInt(g_day_no/146097); g_day_no=g_day_no%146097; var leap=true; if(g_day_no>=36525){g_day_no--; gy+=100*parseInt(g_day_no/36524); g_day_no=g_day_no%36524; if(g_day_no>=365)g_day_no++; else leap=false;} gy+=4*parseInt(g_day_no/1461); g_day_no%=1461; if(g_day_no>=366){leap=false; g_day_no--; gy+=parseInt(g_day_no/365); g_day_no=g_day_no%365;} for(var i=0;g_day_no>=365+(i==1&&leap);i++){g_day_no-=365+(i==1&&leap); gy++;} var gm=0; var gd=0; var gm_days=[31,(leap?29:28),31,30,31,30,31,31,30,31,30,31]; for(var i=0;i<12;i++){if(g_day_no<gm_days[i]){gm=i+1; gd=g_day_no+1; break;}g_day_no-=gm_days[i];} return {y:gy, m:gm, d:gd}; }
    function gregorianToJalali(d) { let g_y=d.getFullYear(), g_m=d.getMonth()+1, g_d=d.getDate(); var g_days_in_month=[31,28,31,30,31,30,31,31,30,31,30,31]; if((g_y%4==0&&g_y%100!=0)||(g_y%400==0))g_days_in_month[1]=29; var gy=g_y-1600; var gm=g_m-1; var gd=g_d-1; var g_day_no=365*gy+parseInt((gy+3)/4)-parseInt((gy+99)/100)+parseInt((gy+399)/400); for(var i=0;i<gm;++i)g_day_no+=g_days_in_month[i]; g_day_no+=gd; var j_day_no=g_day_no-79; var j_np=parseInt(j_day_no/12053); j_day_no=j_day_no%12053; var jy=979+33*j_np+4*parseInt(j_day_no/1461); j_day_no%=1461; if(j_day_no>=366){jy+=parseInt((j_day_no-1)/365); j_day_no=(j_day_no-1)%365;} var jm=0; var jd=0; for(var i=0;i<11&&j_day_no>=(i<6?31:30);++i){j_day_no-=(i<6?31:30); jm++;} jm++; jd=j_day_no+1; return [jy,jm,jd]; }
    function diffDays(j1, j2) { let g1=jalaliToGregorian(j1.y,j1.m,j1.d); let g2=jalaliToGregorian(j2.y,j2.m,j2.d); let d1=new Date(g1.y,g1.m-1,g1.d); let d2=new Date(g2.y,g2.m-1,g2.d); return Math.ceil((d2-d1)/(1000*60*60*24)); }
</script>
</body>
</html>
