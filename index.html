<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F3F4F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <style>
        :root {
            --primary: #00695C;
            --primary-light: #B2DFDB;
            --bg-app: #F3F4F6;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --accent: #F59E0B;
            --danger: #EF4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --radius: 16px;
        }

        [data-theme="dark"] {
            --primary: #80CBC4;
            --primary-light: #004D40;
            --bg-app: #111827;
            --bg-card: #1F2937;
            --text-main: #F9FAFB;
            --text-muted: #9CA3AF;
            --border: #374151;
            --shadow: none;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            /* ÙÙˆÙ†Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø³ÛŒØ³ØªÙ… Ø§Ú¯Ø± ÙˆØ²ÛŒØ± Ù„ÙˆØ¯ Ù†Ø´Ø¯ */
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex; justify-content: center;
            overflow: hidden;
            transition: background 0.3s;
        }

        .app-container {
            width: 100%; height: 100%; max-width: 450px;
            background-color: var(--bg-app);
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- Header --- */
        .header { padding: 15px 20px; background: var(--bg-app); z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title { font-size: 18px; font-weight: 900; color: var(--primary); margin: 0; }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border); border-radius: 10px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 18px; }
        .icon-btn:active { transform: scale(0.9); background: var(--primary-light); color: var(--primary); }

        /* --- Tabs --- */
        .tab-container { background: var(--bg-card); border-radius: 12px; padding: 4px; display: flex; position: relative; box-shadow: var(--shadow); }
        .tab-btn { flex: 1; text-align: center; padding: 10px 0; font-size: 13px; font-weight: bold; color: var(--text-muted); cursor: pointer; z-index: 2; transition: color 0.3s; border-radius: 10px; }
        .tab-btn.active { color: var(--primary); }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø¨Ø±Ø§ÛŒ ØªØ¨ Ø¬Ù‡Øª Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ú¯ */
        .tab-bg { 
            position: absolute; top: 4px; bottom: 4px; right: 4px; 
            width: calc(33.33% - 5px); 
            background: var(--primary-light); border-radius: 10px; opacity: 0.3; 
            transition: transform 0.3s ease; 
            z-index: 1; 
        }

        /* --- Content --- */
        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 180px; scroll-behavior: smooth; }
        .main-content::-webkit-scrollbar { width: 0; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Inputs */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; color: var(--text-muted); margin-bottom: 6px; }
        .input-row { display: flex; gap: 10px; }
        
        input, select { width: 100%; padding: 12px; background: var(--bg-app); border: 1px solid transparent; border-radius: 12px; font-family: 'Vazirmatn', sans-serif; font-size: 16px; color: var(--text-main); text-align: center; transition: 0.2s; height: 48px; }
        input:focus, select:focus { background: var(--bg-card); border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        /* Buttons */
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-family: 'Vazirmatn', sans-serif; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,105,92, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-ghost { background: transparent; color: var(--text-muted); font-size: 12px; padding: 5px; margin-top: 0; width: auto;}
        .btn-add { background: var(--accent); color: white; margin-top: 0; height: 48px; width: 48px; border-radius: 12px; font-size: 24px; padding: 0; }

        /* Chips */
        .chips { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
        .chip { background: var(--bg-app); padding: 8px 0; border-radius: 8px; font-size: 12px; text-align: center; color: var(--text-muted); cursor: pointer; border: 1px solid transparent; }
        .chip.selected { background: var(--primary-light); color: var(--primary); border-color: var(--primary); font-weight: bold; }

        .mode-switch { display: flex; background: var(--bg-app); padding: 3px; border-radius: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; cursor: pointer; border-radius: 8px; color: var(--text-muted); transition: 0.2s; font-weight: bold; }
        .mode-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }

        .result-panel { background: var(--primary); color: white; text-align: center; display: none; margin-top: 15px; border-radius: 16px; padding: 15px; }
        .res-val { font-size: 24px; font-weight: 900; margin: 8px 0; letter-spacing: -1px; }
        .res-lbl { font-size: 12px; opacity: 0.9; }
        .res-sub { border-top: 1px dashed rgba(255,255,255,0.3); margin-top: 10px; padding-top: 10px; font-size: 13px; }

        .cheque-list { margin-top: 10px; }
        .cheque-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); animation: fadeIn 0.2s; }
        .cheque-row:last-child { border: none; }
        .c-date { font-weight: bold; font-size: 14px; }
        .c-amt { color: var(--primary); font-weight: bold; font-size: 14px; }
        .c-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .btn-del { color: var(--danger); font-size: 20px; cursor: pointer; padding: 0 10px; }

        .fixed-footer { position: absolute; bottom: 0; left: 0; right: 0; background: var(--bg-card); padding: 15px 20px 20px 20px; border-radius: 24px 24px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.08); z-index: 100; display: none; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-item span { display: block; }
        .stat-val { font-weight: bold; font-size: 14px; color: var(--text-main); }
        .stat-lbl { font-size: 10px; color: var(--text-muted); }
        .final-box { background: var(--bg-app); border-radius: 12px; padding: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .final-val { font-size: 18px; font-weight: 900; color: var(--accent); }

        .date-select-group { display: flex; gap: 5px; direction: ltr; }
        .date-select-group select { padding: 8px 2px; font-size: 13px; direction: rtl; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-box { background: var(--bg-card); padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 15px; left: 15px; font-size: 24px; cursor: pointer; color: var(--text-muted); }
        .help-item { margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .help-item:last-child { border: none; }
        .help-title { font-weight: 900; color: var(--primary); margin-bottom: 5px; display: block; }
        .help-desc { font-size: 13px; color: var(--text-muted); line-height: 1.6; }

        .ch-mode-panel { display: none; }
        .ch-mode-panel.active { display: block; }
        .signature { text-align: center; font-size: 10px; opacity: 0.4; margin-top: 20px; margin-bottom: 10px; }

    </style>
</head>
<body>

<div class="app-container" id="appContainer">
    
    <div class="header">
        <div class="header-top">
            <div class="header-actions">
                <div class="icon-btn" onclick="toggleHelp()">?</div>
                <div class="icon-btn" onclick="toggleTheme()" id="themeIcon">ğŸŒ™</div>
            </div>
            <h1 class="header-title">Ø¬Ø¹Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø± Ù…Ø§Ù„ÛŒ</h1>
        </div>

        <div class="tab-container" id="tabContainer">
            <div class="tab-btn active" onclick="setTab(0)">Ø§Ù‚Ø³Ø§Ø· ÙˆØ§Ù…</div>
            <div class="tab-btn" onclick="setTab(1)">Ù…Ø¹Ú©ÙˆØ³</div>
            <div class="tab-btn" onclick="setTab(2)">Ø±Ø£Ø³â€ŒÚ¯ÛŒØ± Ú†Ú©</div>
            <div class="tab-bg" id="tabIndicator"></div>
        </div>
    </div>

    <div class="main-content">
        
        <div class="page active" id="page0">
            <div class="card">
                <div class="input-group">
                    <label>Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="tel" id="loanAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ ÛµÛ°,Û°Û°Û°,Û°Û°Û°" oninput="fmt(this); calcLoan()">
                </div>
                
                <div class="input-row">
                    <div class="input-group" style="flex:1">
                        <label>Ø³ÙˆØ¯ Ø³Ø§Ù„ÛŒØ§Ù†Ù‡ %</label>
                        <input type="tel" id="loanRate" value="Û³.Û¹" oninput="fmtFa(this); calcLoan()">
                    </div>
                    <div class="input-group" style="flex:1">
                        <label>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</label>
                        <input type="tel" id="loanMonths" value="Û´" oninput="fmtFa(this); calcLoan()">
                    </div>
                </div>

                <div class="chips">
                    <div class="chip selected" onclick="setM(4, this)">Û´ Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setM(8, this)">Û¸ Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setM(12, this)">Û±Û² Ù…Ø§Ù‡</div>
                    <div class="chip" onclick="setM(16, this)">Û±Û¶ Ù…Ø§Ù‡</div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <label style="margin:0; font-size:13px;">ÛŒÚ© Ù…Ø§Ù‡ Ø³ÙˆØ¯ Ø§Ø¶Ø§ÙÙ‡ (+Û±)</label>
                    <input type="checkbox" id="loanExtra" onchange="calcLoan()" style="width:20px; height:20px;">
                </div>
            </div>

            <div class="card result-panel" id="loanResult">
                <div class="res-lbl" id="loanTotal"></div>
                <div class="res-val" id="loanMonthly"></div>
                <div class="res-sub" id="loanInterest"></div>
                <div style="font-size:10px; margin-top:5px; opacity:0.6;">(Ø±ÙÙ†Ø¯ Ø´Ø¯Ù‡ Ø¨Ù‡ ÛµÛ°Û°Û° ØªÙˆÙ…Ø§Ù† Ø¨Ø§Ù„Ø§)</div>
            </div>
            
            <button class="btn btn-ghost" onclick="resetLoan()">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ±Ù…</button>
        </div>

        <div class="page" id="page1">
            <div class="card">
                <div class="input-group">
                    <label>ØªÙˆØ§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø· (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="tel" id="revAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ûµ,Û°Û°Û°,Û°Û°Û°" oninput="fmt(this); calcRev()">
                </div>
                <div class="input-row">
                    <div class="input-group" style="flex:1">
                        <label>Ø³ÙˆØ¯ %</label>
                        <input type="tel" id="revRate" value="Û³.Û¹" oninput="fmtFa(this); calcRev()">
                    </div>
                    <div class="input-group" style="flex:1">
                        <label>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</label>
                        <input type="tel" id="revMonths" value="Û´" oninput="fmtFa(this); calcRev()">
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="margin:0; font-size:13px;">Ø³ÙˆØ¯ Ø§Ø¶Ø§ÙÙ‡ (+Û±)</label>
                    <input type="checkbox" id="revExtra" onchange="calcRev()" style="width:20px; height:20px;">
                </div>
            </div>

            <div class="card result-panel" id="revResult">
                <div class="res-lbl">Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ Ú©Ø§Ù„Ø§:</div>
                <div class="res-val" id="revPrincipal"></div>
                <div class="res-sub" id="revTotal"></div>
            </div>
        </div>

        <div class="page" id="page2">
            
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:end;">
                <div style="width: 70px;">
                    <label style="font-size:10px; color:var(--text-muted);">Ø¯Ø±ØµØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡</label>
                    <input type="tel" id="chRate" value="Ûµ" oninput="fmtFa(this); calcCh()" style="padding:8px; height:35px;">
                </div>
                
                <div style="flex:1; margin:0 10px;">
                    <label style="font-size:10px; color:var(--text-muted); text-align:center; display:block;">ØªØ§Ø±ÛŒØ® Ù…Ø¨Ù†Ø§ (Ø§Ù…Ø±ÙˆØ²)</label>
                    <div class="date-select-group" style="justify-content:center;">
                        <select id="baseY" onchange="updBase()"></select>
                        <select id="baseM" onchange="updBase()"></select>
                        <select id="baseD" onchange="updBase()"></select>
                    </div>
                </div>
                
                <button class="btn-ghost" onclick="resetCh()" style="color:var(--danger);">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
            </div>

            <div class="mode-switch">
                <div class="mode-btn active" onclick="setChMode('single')" id="btnModeSingle">ÙˆØ±ÙˆØ¯ ØªÚ©ÛŒ (Ø¯Ø³ØªÛŒ)</div>
                <div class="mode-btn" onclick="setChMode('batch')" id="btnModeBatch">ØªÙˆÙ„ÛŒØ¯ Ú¯Ø±ÙˆÙ‡ÛŒ (Ø§Ù‚Ø³Ø§Ø·)</div>
            </div>

            <div class="card">
                <div id="panelSingle" class="ch-mode-panel active">
                    <div class="input-row">
                        <div class="input-group" style="flex:1">
                            <label>Ù…Ø¨Ù„Øº Ú†Ú©</label>
                            <input type="tel" id="chAmtS" placeholder="ØªÙˆÙ…Ø§Ù†" oninput="fmt(this)">
                        </div>
                        <div class="input-group" style="width: 50px;">
                            <label>&nbsp;</label>
                            <button class="btn-add" onclick="addSingle()">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ØªØ§Ø±ÛŒØ® Ú†Ú©</label>
                        <div class="date-select-group">
                            <select id="chYS"></select>
                            <select id="chMS"></select>
                            <select id="chDS"></select>
                        </div>
                    </div>
                </div>

                <div id="panelBatch" class="ch-mode-panel">
                    <div class="input-row">
                        <div class="input-group" style="flex:2">
                            <label>Ù…Ø¨Ù„Øº Ù‡Ø± Ú†Ú©</label>
                            <input type="tel" id="chAmtB" placeholder="ØªÙˆÙ…Ø§Ù†" oninput="fmt(this)">
                        </div>
                        <div class="input-group" style="flex:1">
                            <label>ØªØ¹Ø¯Ø§Ø¯</label>
                            <input type="tel" id="chCntB" placeholder="Ø¹Ø¯Ø¯" oninput="fmtFa(this)">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group" style="flex:1">
                            <label>ÙØ§ØµÙ„Ù‡ (Ù…Ø§Ù‡)</label>
                            <select id="chStepB" style="padding:0 5px;" onchange="updDefDateBatch()">
                                <option value="1">Û± Ù…Ø§Ù‡Ù‡</option><option value="2">Û² Ù…Ø§Ù‡Ù‡</option>
                                <option value="3">Û³ Ù…Ø§Ù‡Ù‡</option><option value="4">Û´ Ù…Ø§Ù‡Ù‡</option>
                            </select>
                        </div>
                        <div class="input-group" style="flex:2">
                            <label>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
                            <div class="date-select-group">
                                <select id="chYB"></select>
                                <select id="chMB"></select>
                                <select id="chDB"></select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addBatch()">ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒØ³Øª</button>
                </div>
            </div>

            <div class="card" style="padding: 10px 15px; min-height: 100px;">
                <div style="font-size:12px; font-weight:bold; color:var(--text-muted); margin-bottom:5px;">Ù„ÛŒØ³Øª Ú†Ú©â€ŒÙ‡Ø§</div>
                <div class="cheque-list" id="chList"></div>
            </div>
        </div>

    </div>

    <div class="fixed-footer" id="chFooter">
        <div class="grid-4">
            <div class="stat-item"><span class="stat-val" id="fCnt">Û°</span><span class="stat-lbl">ØªØ¹Ø¯Ø§Ø¯</span></div>
            <div class="stat-item"><span class="stat-val" id="fDays">Û°</span><span class="stat-lbl">Ø±ÙˆØ² Ø±Ø£Ø³</span></div>
            <div class="stat-item"><span class="stat-val" id="fInt">Û°</span><span class="stat-lbl">Ú©Ø§Ø±Ù…Ø²Ø¯</span></div>
            <div class="stat-item"><span class="stat-val" id="fTot">Û°</span><span class="stat-lbl">Ú©Ù„</span></div>
        </div>
        <div class="final-box">
            <span style="font-size:13px;">Ø®Ø§Ù„Øµ Ø¯Ø±ÛŒØ§ÙØªÛŒ:</span>
            <span class="final-val" id="fNet">Û°</span>
        </div>
        <div style="text-align:center; font-size:11px; margin-top:5px; color:var(--text-muted);">
            ØªØ§Ø±ÛŒØ® Ø±Ø£Ø³: <span id="fDate" style="font-weight:bold;">---</span>
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="if(event.target===this)toggleHelp()">
        <div class="modal-box">
            <div class="modal-close" onclick="toggleHelp()">Ã—</div>
            <h3 style="margin-top:0; color:var(--text-main);">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡</h3>
            <div class="help-item">
                <span class="help-title">Û±. Ø§Ù‚Ø³Ø§Ø· ÙˆØ§Ù…</span>
                <span class="help-desc">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¨Ù„Øº Ù‚Ø³Ø·ØŒ Ø³ÙˆØ¯ Ú©Ù„ Ùˆ Ø¬Ù…Ø¹ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ùˆ Ù†Ø±Ø® Ø³ÙˆØ¯. Ú¯Ø²ÛŒÙ†Ù‡ "+Û±" Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ ÛŒÚ© Ù…Ø§Ù‡ Ø§Ø¶Ø§ÙÙ‡ (Ø¹Ø±Ù Ø¨Ø§Ø²Ø§Ø±) Ø§Ø³Øª.</span>
            </div>
            <div class="help-item">
                <span class="help-title">Û². Ù…Ø¹Ú©ÙˆØ³</span>
                <span class="help-desc">Ø§Ú¯Ø± Ù…Ø´ØªØ±ÛŒ Ø¨Ú¯ÙˆÛŒØ¯ "Ù…Ø§Ù‡ÛŒ Ûµ ØªÙˆÙ…Ø§Ù† Ù‚Ø³Ø· Ù…ÛŒâ€ŒØ¯Ù‡Ù…"ØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ú†Ù‚Ø¯Ø± Ø¬Ù†Ø³ Ù†Ù‚Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ø§Ùˆ Ø¨Ø¯Ù‡ÛŒØ¯.</span>
            </div>
            <div class="help-item">
                <span class="help-title">Û³. Ø±Ø£Ø³â€ŒÚ¯ÛŒØ± Ú†Ú©</span>
                <span class="help-desc">Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† (Ø±Ø£Ø³) Ø¨Ø±Ø§ÛŒ Ú†Ù†Ø¯ Ú†Ú©. <br> <b>ÙˆØ±ÙˆØ¯ ØªÚ©ÛŒ:</b> Ú†Ú©â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø§Ù†Ù‡â€ŒØ¯Ø§Ù†Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. <br> <b>ØªÙˆÙ„ÛŒØ¯ Ú¯Ø±ÙˆÙ‡ÛŒ:</b> Ø§Ù‚Ø³Ø§Ø· Ù…Ù†Ø¸Ù… Ø±Ø§ Ø¨Ø§ ÛŒÚ© Ú©Ù„ÛŒÚ© Ø¨Ø³Ø§Ø²ÛŒØ¯.</span>
            </div>
            <div class="signature">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³: Ø­ÛŒØ¯Ø± Ø­ÛŒØ¯Ø±ÛŒ</div>
        </div>
    </div>

</div>

<script>
    // --- Tools ---
    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙØ§ØµÙ„Ù‡ ÛŒØ§ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ø¶Ø§ÙÛŒ
    const _ = id => document.getElementById(id);
    const toFa = n => (n===undefined||n===null)?'':n.toString().replace(/\d/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);
    const toEn = s => s ? s.toString().replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)).replace(/,/g,'') : '';
    const sep = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    
    function fmt(el) { 
        let valStr = toEn(el.value); 
        let v = valStr.replace(/[^0-9]/g,''); 
        if(!v) { el.value = ''; return; }
        el.value = toFa(parseInt(v).toLocaleString()); 
    }
    
    function fmtFa(el) { 
        let v = toEn(el.value); 
        el.value = v ? toFa(v) : ''; 
    }

    // --- Init ---
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² DOMContentLoaded Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ùˆ Ù…Ø·Ù…Ø¦Ù†
    document.addEventListener('DOMContentLoaded', function() {
        initDate();
        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù…Ø®ÙÛŒ Ø¨ÙˆØ¯Ù† Ù†ØªØ§ÛŒØ¬ Ø¯Ø± Ø´Ø±ÙˆØ¹
        _('loanResult').style.display = 'none';
        _('revResult').style.display = 'none';
    });

    // --- Layout & Theme ---
    function setTab(idx) {
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        document.querySelectorAll('.page').forEach((p, i) => p.classList.toggle('active', i === idx));
        _('tabIndicator').style.transform = `translateX(${idx * -100}%)`;
        const footer = _('chFooter');
        footer.style.display = (idx === 2) ? 'block' : 'none';
    }

    function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        document.querySelector('meta[name="theme-color"]').setAttribute('content', newTheme==='dark'?'#111827':'#F3F4F6');
        _('themeIcon').innerText = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    function toggleHelp() {
        const m = _('helpModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    // --- Loan Logic ---
    function setM(m, el) { 
        _('loanMonths').value = toFa(m); 
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected')); 
        el.classList.add('selected'); 
        calcLoan(); 
    }
    
    function calcLoan() {
        let p = parseFloat(toEn(_('loanAmount').value));
        let m = parseInt(toEn(_('loanMonths').value));
        let r = parseFloat(toEn(_('loanRate').value));
        
        if(!p || !m || isNaN(p) || isNaN(m)) { 
            _('loanResult').style.display='none'; 
            return; 
        }
        
        let extra = _('loanExtra').checked ? 1 : 0;
        let intM = m + extra; 
        let interest = p * (r/100) * intM;
        let total = p + interest;
        let monthly = Math.ceil((total / m) / 5000) * 5000;
        let finalTotal = monthly * m;
        let finalInt = finalTotal - p;
        
        _('loanTotal').innerText = `Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù„: ${toFa(sep(finalTotal))} ØªÙˆÙ…Ø§Ù†`;
        _('loanMonthly').innerText = `${toFa(sep(monthly))} ØªÙˆÙ…Ø§Ù†`;
        _('loanInterest').innerText = `Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ: ${toFa(sep(finalInt))} ØªÙˆÙ…Ø§Ù†`;
        _('loanResult').style.display='block';
    }
    
    function resetLoan() { 
        _('loanAmount').value=''; 
        _('loanResult').style.display='none'; 
        _('loanMonths').value = toFa(4);
    }

    // --- Reverse Logic ---
    function calcRev() {
        let mont = parseFloat(toEn(_('revAmount').value));
        let m = parseInt(toEn(_('revMonths').value));
        let r = parseFloat(toEn(_('revRate').value));
        
        if(!mont || !m || isNaN(mont) || isNaN(m)) { 
            _('revResult').style.display='none'; 
            return; 
        }
        
        let extra = _('revExtra').checked ? 1 : 0;
        let intM = m + extra;
        let totalPay = mont * m;
        let factor = 1 + ((r/100) * intM);
        let principal = Math.round(totalPay / factor);
        
        _('revPrincipal').innerText = `${toFa(sep(principal))} ØªÙˆÙ…Ø§Ù†`;
        _('revTotal').innerText = `Ø¬Ù…Ø¹ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª: ${toFa(sep(totalPay))}`;
        _('revResult').style.display='block';
    }

    // --- Cheque Logic ---
    let cheques = [];
    let baseDate = {};

    function initDate() {
        const fill = (ids, start, end) => { 
            ids.forEach(id => { 
                let h = ''; 
                for(let i=start; i<=end; i++) h += `<option value="${i}">${toFa(i)}</option>`; 
                let el = _(id);
                if(el) el.innerHTML = h; 
            }); 
        };
        
        fill(['baseD','chDS','chDB'], 1, 31);
        fill(['baseM','chMS','chMB'], 1, 12);
        fill(['baseY','chYS','chYB'], 1402, 1410);
        
        const j = gregorianToJalali(new Date());
        baseDate = { y: j[0], m: j[1], d: j[2] };
        
        // ØªÙ†Ø¸ÛŒÙ… Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡
        ['baseY','chYS','chYB'].forEach(id => { if(_(id)) _(id).value = j[0]; });
        ['baseM','chMS','chMB'].forEach(id => { if(_(id)) _(id).value = j[1]; });
        ['baseD','chDS','chDB'].forEach(id => { if(_(id)) _(id).value = j[2]; });
        
        updDefDateBatch();
    }

    function updBase() { 
        baseDate = { y: parseInt(_('baseY').value), m: parseInt(_('baseM').value), d: parseInt(_('baseD').value) }; 
        calcCh(); 
    }
    
    function updDefDateBatch() {
        let step = parseInt(_('chStepB').value);
        let by = parseInt(_('baseY').value), bm = parseInt(_('baseM').value), bd = parseInt(_('baseD').value);
        let g = jalaliToGregorian(by, bm, bd);
        let d = new Date(g.y, g.m-1, g.d); d.setMonth(d.getMonth() + step);
        let j = gregorianToJalali(d);
        _('chYB').value = j[0]; _('chMB').value = j[1]; _('chDB').value = j[2];
    }

    function setChMode(mode) {
        if(mode === 'single') {
            _('btnModeSingle').classList.add('active'); _('btnModeBatch').classList.remove('active');
            _('panelSingle').classList.add('active'); _('panelBatch').classList.remove('active');
        } else {
            _('btnModeSingle').classList.remove('active'); _('btnModeBatch').classList.add('active');
            _('panelSingle').classList.remove('active'); _('panelBatch').classList.add('active');
        }
    }

    function addSingle() {
        let amt = parseInt(toEn(_('chAmtS').value));
        if(!amt || isNaN(amt)) return;
        let y = parseInt(_('chYS').value), m = parseInt(_('chMS').value), d = parseInt(_('chDS').value);
        cheques.push({ y:y, m:m, d:d, amt:amt });
        recalcBalances(); renderCh(); _('chAmtS').value = '';
    }

    function addBatch() {
        let amt = parseInt(toEn(_('chAmtB').value));
        let cnt = parseInt(toEn(_('chCntB').value));
        if(!amt || !cnt || isNaN(amt) || isNaN(cnt)) return;
        let step = parseInt(_('chStepB').value);
        let sy = parseInt(_('chYB').value), sm = parseInt(_('chMB').value), sd = parseInt(_('chDB').value);
        for(let i=0; i<cnt; i++) {
            let addM = i * step; let tm = sm + addM;
            let ny = sy + Math.floor((tm-1)/12);
            let nm = ((tm-1)%12) + 1;
            let nd = sd; if(nm>6 && nd==31) nd=30; if(nm==12 && nd>29) nd=29;
            cheques.push({ y:ny, m:nm, d:nd, amt:amt });
        }
        recalcBalances(); renderCh();
    }

    function recalcBalances() {
        let total = cheques.reduce((acc, c) => acc + c.amt, 0);
        let running = total;
        cheques.forEach(c => { c.bal = running - c.amt; running -= c.amt; });
    }

    function renderCh() {
        let h = '';
        cheques.forEach((c, i) => {
            let days = diffDays(baseDate, {y:c.y, m:c.m, d:c.d});
            h += `
            <div class="cheque-row">
                <div style="flex:1">
                    <div class="c-date">${toFa(c.y)}/${toFa(c.m)}/${toFa(c.d)} <span style="font-weight:normal; font-size:11px; color:#666">(${toFa(days)} Ø±ÙˆØ²)</span></div>
                    <div class="c-sub">Ù…Ø§Ù†Ø¯Ù‡: ${toFa(sep(c.bal))}</div>
                </div>
                <div style="text-align:left">
                    <div class="c-amt">${toFa(sep(c.amt))}</div>
                    <span class="btn-del" onclick="delCh(${i})">Ã—</span>
                </div>
            </div>`;
        });
        _('chList').innerHTML = h;
        calcCh();
    }

    function delCh(i) { cheques.splice(i, 1); recalcBalances(); renderCh(); }

    function calcCh() {
        let tot = 0, wSum = 0;
        cheques.forEach(c => { tot += c.amt; wSum += c.amt * diffDays(baseDate, {y:c.y, m:c.m, d:c.d}); });
        let ras = tot>0 ? wSum/tot : 0;
        let rate = parseFloat(toEn(_('chRate').value)) || 0;
        let interest = tot * (rate/100) * (ras/30);
        let rdStr = "---";
        if(tot > 0) {
            let g = jalaliToGregorian(baseDate.y, baseDate.m, baseDate.d);
            let t = new Date(g.y, g.m-1, g.d); t.setDate(t.getDate() + Math.round(ras));
            let j = gregorianToJalali(t);
            rdStr = `${toFa(j[0])}/${toFa(j[1])}/${toFa(j[2])}`;
        }
        _('fCnt').innerText = toFa(cheques.length);
        _('fDays').innerText = toFa(Math.round(ras));
        _('fTot').innerText = toFa(sep(tot));
        _('fInt').innerText = toFa(sep(Math.round(interest)));
        _('fNet').innerText = toFa(sep(Math.round(tot - interest)));
        _('fDate').innerText = rdStr;
    }

    function resetCh() { cheques=[]; renderCh(); updDefDateBatch(); _('chAmtB').value=''; _('chCntB').value=''; _('chAmtS').value=''; }

    function jalaliToGregorian(j_y, j_m, j_d) {
        j_y=parseInt(j_y); j_m=parseInt(j_m); j_d=parseInt(j_d); var jy=j_y-979; var jm=j_m-1; var jd=j_d-1; var j_day_no=365*jy+parseInt(jy/33)*8+parseInt((jy%33+3)/4); for(var i=0;i<jm;++i)j_day_no+=(i<6)?31:30; j_day_no+=jd; var g_day_no=j_day_no+79; var gy=1600+400*parseInt(g_day_no/146097); g_day_no=g_day_no%146097; var leap=true; if(g_day_no>=36525){g_day_no--; gy+=100*parseInt(g_day_no/36524); g_day_no=g_day_no%36524; if(g_day_no>=365)g_day_no++; else leap=false;} gy+=4*parseInt(g_day_no/1461); g_day_no%=1461; if(g_day_no>=366){leap=false; g_day_no--; gy+=parseInt(g_day_no/365); g_day_no=g_day_no%365;} for(var i=0;g_day_no>=365+(i==1&&leap);i++){g_day_no-=365+(i==1&&leap); gy++;} var gm=0; var gd=0; var gm_days=[31,(leap?29:28),31,30,31,30,31,31,30,31,30,31]; for(var i=0;i<12;i++){if(g_day_no<gm_days[i]){gm=i+1; gd=g_day_no+1; break;}g_day_no-=gm_days[i];} return {y:gy, m:gm, d:gd};
    }
    function gregorianToJalali(d) {
        let g_y=d.getFullYear(), g_m=d.getMonth()+1, g_d=d.getDate(); var g_days_in_month=[31,28,31,30,31,30,31,31,30,31,30,31]; if((g_y%4==0&&g_y%100!=0)||(g_y%400==0))g_days_in_month[1]=29; var gy=g_y-1600; var gm=g_m-1; var gd=g_d-1; var g_day_no=365*gy+parseInt((gy+3)/4)-parseInt((gy+99)/100)+parseInt((gy+399)/400); for(var i=0;i<gm;++i)g_day_no+=g_days_in_month[i]; g_day_no+=gd; var j_day_no=g_day_no-79; var j_np=parseInt(j_day_no/12053); j_day_no=j_day_no%12053; var jy=979+33*j_np+4*parseInt(j_day_no/1461); j_day_no%=1461; if(j_day_no>=366){jy+=parseInt((j_day_no-1)/365); j_day_no=(j_day_no-1)%365;} var jm=0; var jd=0; for(var i=0;i<11&&j_day_no>=(i<6?31:30);++i){j_day_no-=(i<6?31:30); jm++;} jm++; jd=j_day_no+1; return [jy,jm,jd];
    }
    function diffDays(j1, j2) {
        let g1 = jalaliToGregorian(j1.y, j1.m, j1.d); let g2 = jalaliToGregorian(j2.y, j2.m, j2.d);
        let d1 = new Date(g1.y, g1.m-1, g1.d); let d2 = new Date(g2.y, g2.m-1, g2.d);
        return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
    }
</script>
</body>
</html>